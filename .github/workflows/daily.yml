name: NBA Daily Predictions - Full Pipeline

on:
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6:00 AM UTC (11:30 AM IST)
  workflow_dispatch:  # Allow manual trigger

jobs:
  predict:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # ===== STEP 1: FETCH DATA =====
      - name: Create pre_match folder
        run: mkdir -p pre_match
      
      - name: Verify checked out files
        run: |
          echo "üìÇ Current directory:"
          pwd
          echo ""
          echo "üìã All files in repository:"
          ls -la
          echo ""
          echo "üêç Python files:"
          ls -la *.py || echo "No Python files found in root"
      
      - name: Step 1 - Fetch today's matches and features
        run: |
          echo "üîç Fetching today's NBA matches..."
          python Pre_Match.py
        continue-on-error: false
      
      - name: Step 2 - Extract odds and features
        run: |
          echo "üìä Extracting DraftKings odds and features..."
          python Odds_Pre_Match.py
        continue-on-error: false
      
      - name: Step 3 - Generate Future.csv (Combine data)
        run: |
          echo "üîó Combining features into Future.csv..."
          if [ ! -f "Combine.py" ]; then
            echo "‚ùå ERROR: Combine.py not found!"
            ls -la
            exit 1
          fi
          python Combine.py
        continue-on-error: false
      
      - name: Verify Future.csv was created
        run: |
          echo "üìã Checking generated CSV files:"
          ls -lh *.csv 2>/dev/null || echo "No CSV files found in root"
          echo ""
          if [ -f "Future.csv" ]; then
            echo "‚úÖ Future.csv generated successfully"
            echo "File size: $(ls -lh Future.csv | awk '{print $5}')"
            echo "Lines: $(wc -l Future.csv)"
          else
            echo "‚ùå ERROR: Future.csv not found!"
            exit 1
          fi
      
      - name: Verify trained models exist
        run: |
          echo "ü§ñ Checking trained models..."
          if [ -d "model" ]; then
            echo "‚úÖ model/ folder found"
            ls -lh model/
            
            required_files=("hybrid_home_xgb.pkl" "hybrid_away_xgb.pkl" "hybrid_scaler.pkl")
            missing=0
            for file in "${required_files[@]}"; do
              if [ -f "model/$file" ]; then
                echo "  ‚úÖ $file"
              else
                echo "  ‚ùå $file MISSING"
                missing=$((missing+1))
              fi
            done
            
            if [ $missing -gt 0 ]; then
              echo ""
              echo "‚ùå ERROR: Missing $missing model file(s)"
              echo "Make sure these files are committed to your repo in the model/ folder"
              exit 1
            fi
          else
            echo "‚ùå ERROR: model/ folder not found in repo root"
            echo "Please commit your trained models to: ./model/"
            exit 1
          fi
      
      # ===== STEP 2: GENERATE PREDICTIONS =====
      - name: Step 4 - Generate model predictions
        run: |
          echo "üöÄ Running ML predictions..."
          python predict.py
        continue-on-error: false
      
      - name: Verify prediction output
        run: |
          echo "üìä Checking prediction outputs:"
          if [ -f "NBA_PREDICTIONS.csv" ]; then
            echo "‚úÖ NBA_PREDICTIONS.csv generated"
            echo "  Size: $(ls -lh NBA_PREDICTIONS.csv | awk '{print $5}')"
            echo "  Lines: $(wc -l NBA_PREDICTIONS.csv)"
          else
            echo "‚ùå NBA_PREDICTIONS.csv not found"
          fi
      
      - name: Copy latest predictions to repo root
        run: |
          echo "üìã Predictions already in root, preparing for commit..."
          
          echo "üìÅ Files ready for commit:"
          ls -lh *.csv 2>/dev/null || echo "No CSV files in root"
      
      # ===== STEP 3: COMMIT & PUSH =====
      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Pull before pushing to avoid conflicts
          echo "üîÑ Syncing with remote..."
          git pull --rebase origin main 2>/dev/null || git pull --rebase origin master 2>/dev/null || echo "Already up to date"
          
          # Add generated CSV files
          echo "üìÅ Adding prediction files..."
          git add -f nba_prematch_features.csv upcoming_nba_draftkings_odds.csv Future.csv NBA_PREDICTIONS.csv 2>/dev/null || echo "Adding available files"
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi
          
          # Commit changes
          echo "‚úÖ Changes detected, committing..."
          git commit -m "ü§ñ Auto: NBA predictions $(date +'%Y-%m-%d %H:%M UTC')"
          
          # Push with retry logic
          max_retries=5
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            retry_count=$((retry_count+1))
            echo "üì§ Push attempt $retry_count/$max_retries..."
            
            if git push origin main 2>&1; then
              echo "‚úÖ Successfully pushed to main!"
              exit 0
            elif git push origin master 2>&1; then
              echo "‚úÖ Successfully pushed to master!"
              exit 0
            fi
            
            if [ $retry_count -lt $max_retries ]; then
              echo "‚è≥ Retrying in 10 seconds..."
              sleep 10
              git pull --rebase origin main 2>&1 || git pull --rebase origin master 2>&1 || true
            fi
          done
          
          echo "‚ùå Failed to push after $max_retries attempts"
          exit 1
        continue-on-error: true
      
      # Upload as backup
      - name: Upload predictions as backup artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nba-predictions-${{ github.run_number }}
          path: |
            nba_prematch_features.csv
            upcoming_nba_draftkings_odds.csv
            Future.csv
            NBA_PREDICTIONS.csv
          retention-days: 7
